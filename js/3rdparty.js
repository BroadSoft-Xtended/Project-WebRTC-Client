/***************************************************
* Created on Mon Jan 14 15:32:43 GMT 2013 by:
*
* Copyright 2014 Broadsoft
* http://www.broadsoft.com
***************************************************/


function getLastValue(a,b,c,d){return getLastValueAt(a,b,c,d,1)}function getLastValueAt(a,b,c,d,e){var f=getDataSeries(a.id,b,c,d);return f?f.dataPoints_[f.dataPoints_.length-e].value:null}function getAvgValue(a,b,c,d){var e=getDataSeries(a.id,b,c,d);return e?e.getAvg():null}function getDataSeries(a,b,c,d){var e=this.dataSeriesId(a,b,c,d);return dataSeries[e]}function getDataSeriesByLabel(a,b,c){var d=Object.keys(dataSeries),e=[],f=new RegExp(a+".*"+b+".*"+c);for(i=0;i<d.length;i++){var g=d[i];if(f.test(g)){e.push(dataSeries[g])}}return e}function getValueBefore(a,b,c,d,e){var f=this.dataSeriesId(a.id,b,c,d),g=dataSeries[f];if(g){for(i=g.dataPoints_.length-1;i>=0;i--)if(g.dataPoints_[i].time<e)return g.dataPoints_[i].value;return g.dataPoints_[0].value}return null}function dataSeriesId(a,b,c,d){return a+"-"+b+"-"+c+"-"+d}function graphViewId(a,b,c,d){return a.id+"-"+b+"-"+c+"-"+d}function matchesType(a,b,c){return"video"==b&&isVideoStats(c)?!0:"audio"==b&&isAudioStats(c)&&("googJitterReceived"!=a||containsLabel(c,"audioOutputLevel"))?!0:!1}function isVideoStats(a){return containsLabel(a,"googFrameHeightSent")||containsLabel(a,"googFrameHeightReceived")}function isAudioStats(a){return containsLabel(a,"audioInputLevel")||containsLabel(a,"audioOutputLevel")}function getStatsDataType(a,b){return isVideoStats(b)?"video":isAudioStats(b)&&("googJitterReceived"!=a||containsLabel(b,"audioOutputLevel"))?"audio":null}function containsLabel(a,b){for(var c=0;c<a.length-1;c+=2)if(a[c]==b)return!0;return!1}function updateGraph(a,b,c,d,e){var f=bweCompoundGraphConfig[e]?"bweCompound":e,g=this.graphViewId(a,b,c,f);if(!graphViews[g]){var h=getStatsDataType(e,d.values);graphViews[g]=createStatsGraphView(a,b,c,f,h);var i=new Date(d.timestamp);graphViews[g].setDateRange(i,i)}var j=this.dataSeriesId(a.id,b,c,e);graphViews[g].hasDataSeries(dataSeries[j])||graphViews[g].addDataSeries(dataSeries[j]),graphViews[g].updateEndDate()}function drawSingleReport(a,b,c,d){if(d&&d.values)for(var e=0;e<d.values.length-1;e+=2){var f=d.values[e],g=parseInt(d.values[e+1]);if(!isNaN(g)){var h=dataSeriesId(a.id,b,c,f),i=h,j=f,k=g;dataConversionConfig[f]&&(addDataSeriesPoint(h,d.timestamp,f,g),k=dataConversionConfig[f].convertFunction(dataSeries[h],a,b,c),j=dataConversionConfig[f].convertedName,i=dataSeriesId(a.id,b,c,j)),addDataSeriesPoint(i,d.timestamp,j,k),updateGraph(a,b,c,d,f),j!=f&&updateGraph(a,b,c,d,j)}}}function addDataSeriesPoint(a,b,c,d){dataSeries[a]||(dataSeries[a]=new TimelineDataSeries,bweCompoundGraphConfig[c]&&dataSeries[a].setColor(bweCompoundGraphConfig[c].color)),"packetsLost"==c&&0>d&&(d=0),dataSeries[a].addPoint(b,d)}function ensureStatsGraphTopContainer(a,b,c){var d=a.id+"-"+b+"-"+c+"-graph-container",e=$('[id="'+d+'"]')[0];return e||(e=document.createElement("div"),e.id=d,e.className="stats-graph-container",a.appendChild(e)),e}function createStatsGraphView(a,b,c,d,e){var f=ensureStatsGraphTopContainer(a,b,c),g=a.id+"-"+b+"-"+c+"-"+d,h=g+"-div",i=g+"-canvas",j=document.createElement("div");return j.className="stats-graph-sub-container "+d+"-"+e,f.appendChild(j),j.innerHTML="<div>"+d+"</div><div id="+h+"><canvas id="+i+"></canvas></div>","bweCompound"==d&&j.insertBefore(createBweCompoundLegend(a,b+"-"+c),$('[id="'+h+'"]')[0]),new TimelineGraphView(h,i)}function createBweCompoundLegend(a,b){var c=document.createElement("div");for(var d in bweCompoundGraphConfig){var e=document.createElement("div");c.appendChild(e),e.innerHTML="<input type=checkbox checked></input>"+d,e.style.color=bweCompoundGraphConfig[d].color,e.dataSeriesId=a.id+"-"+b+"-"+d,e.graphViewId=a.id+"-"+b+"-bweCompound",e.firstChild.addEventListener("click",function(a){var b=dataSeries[a.target.parentNode.dataSeriesId];b.show(a.target.checked),graphViews[a.target.parentNode.graphViewId].repaint()})}return c}function initialize(){ssrcInfoManager=new SsrcInfoManager,peerConnectionUpdateTable=new PeerConnectionUpdateTable,statsTable=new StatsTable(ssrcInfoManager)}function getPeerConnectionId(a){return a.pid+"-"+a.lid}function extractSsrcInfo(a){("setLocalDescription"==a.type||"setRemoteDescription"==a.type)&&ssrcInfoManager.addSsrcStreamInfo(a.value)}function removePeerConnection(a){var b=$('[id="'+getPeerConnectionId(a)+'"]')[0];b&&peerConnectionsListElem.removeChild(b)}function addPeerConnection(a){var b=$('[id="'+getPeerConnectionId(a)+'"]')[0];return b||(b=document.createElement("li"),peerConnectionsListElem.appendChild(b),b.id=getPeerConnectionId(a)),b.innerHTML="<h3>PeerConnection "+b.id+"</h3><div>"+a.url+" "+a.servers+" "+a.constraints+"</div>",b.firstChild.title="Click to collapse or expand",b.firstChild.addEventListener("click",function(a){a.target.parentElement.className=""==a.target.parentElement.className?"peer-connection-hidden":""}),b}function updatePeerConnection(a){var b=$('[id="'+getPeerConnectionId(a)+'"]')[0];peerConnectionUpdateTable.addPeerConnectionUpdate(b,a),extractSsrcInfo(a)}function updateAllPeerConnections(a){for(var b=0;b<a.length;++b)for(var c=addPeerConnection(a[b]),d=a[b].log,e=0;e<d.length;++e)peerConnectionUpdateTable.addPeerConnectionUpdate(c,d[e]),extractSsrcInfo(d[e])}function addStats(a){var b=getPeerConnectionElement(a);if(b)for(var c=0;c<a.reports.length;++c){var d=a.reports[c];if(drawSingleReport(b,d.type,d.id,d.stats),statsTable.addStatsReport(b,d.type,d.id,d),isVideoStats(d.stats.values)){var e=new Date((new Date).getTime()-6e4),f=getLastValue(b,d.type,d.id,"packetsLost"),g=getLastValue(b,d.type,d.id,"packetsReceived");if(null!=f&&null!=g){var h=getValueBefore(b,d.type,d.id,"packetsLost",e),i=getValueBefore(b,d.type,d.id,"packetsReceived",e),j=(f-h)/(g-i)*100;10>j?($("#quality1").fadeIn(10),$("#quality2, #quality3, #quality4").fadeOut(10)):j>10&&20>j?($("#quality2").fadeIn(10),$("#quality1, #quality3, #quality4").fadeOut(10)):j>20&&100>j?($("#quality3").fadeIn(10),$("#quality1, #quality2, #quality4").fadeOut(10)):j>100&&1e3>j&&($("#quality4").fadeIn(10),$("#quality1, #quality2, #quality3").fadeOut(10))}}}}function getPeerConnectionElement(a){return $('[id="'+getPeerConnectionId(a)+'"]')[0]}function updateDumpStatus(a){dumpCreator.onUpdate(a)}var peerConnectionsListElem=null,ssrcInfoManager=null,peerConnectionUpdateTable=null,statsTable=null,dumpCreator=null,SsrcInfoManager=function(){"use strict";function a(){this.streamInfoContainer_={},this.ATTRIBUTE_SEPARATOR_=/[\r,\n]/,this.FIELD_SEPARATOR_REGEX_=/ .*:/,this.SSRC_ATTRIBUTE_PREFIX_="a=ssrc:",this.SSRC_INFO_BLOCK_CLASS_="ssrc-info-block"}return a.prototype={addSsrcStreamInfo:function(a){for(var b=a.split(this.ATTRIBUTE_SEPARATOR_),c=0;c<b.length;++c)if(0==b[c].indexOf(this.SSRC_ATTRIBUTE_PREFIX_)){var d=b[c].search(this.FIELD_SEPARATOR_REGEX_);if(-1!=d){var e=b[c].substring(this.SSRC_ATTRIBUTE_PREFIX_.length,d);this.streamInfoContainer_[e]||(this.streamInfoContainer_[e]={});for(var f,g,h=b[c].substring(d+1);h.length>0;)d=h.search(this.FIELD_SEPARATOR_REGEX_),-1==d&&(d=h.length),f=h.substring(0,h.indexOf(":")),g=h.substring(h.indexOf(":")+1,d),this.streamInfoContainer_[e][f]=g,h=h.substring(d+1)}}},getStreamInfo:function(a){return this.streamInfoContainer_[a]},populateSsrcInfo:function(a,b){if(this.streamInfoContainer_[b]){a.className=this.SSRC_INFO_BLOCK_CLASS_;var c;for(var d in this.streamInfoContainer_[b])c=document.createElement("div"),a.appendChild(c),c.textContent=d+":"+this.streamInfoContainer_[b][d]}}},a}(),TimelineDataSeries=function(){"use strict";function a(){this.dataPoints_=[],this.color_="red",this.isVisible_=!0,this.cacheStartTime_=null,this.cacheStepSize_=0,this.cacheValues_=[]}function b(a,b){this.time=a,this.value=b}return a.prototype={addPoint:function(a,c){var d=new Date(a);this.dataPoints_.push(new b(d,c))},isVisible:function(){return this.isVisible_},show:function(a){this.isVisible_=a},getColor:function(){return this.color_},setColor:function(a){this.color_=a},getAvg:function(){for(var a=0,b=0;b<this.dataPoints_.length;b++)a+=this.dataPoints_[b].value;return a/this.dataPoints_.length},getValues:function(a,b,c){return this.cacheStartTime_==a&&this.cacheStepSize_==b&&this.cacheValues_.length==c?this.cacheValues_:(this.cacheValues_=this.getValuesInternal_(a,b,c),this.cacheStartTime_=a,this.cacheStepSize_=b,this.cacheValues_)},getValuesInternal_:function(a,b,c){for(var d=[],e=0,f=0,g=a,h=0;c>h;++h){for(;e<this.dataPoints_.length&&this.dataPoints_[e].time<g;)f=this.dataPoints_[e].value,++e;d[h]=f,g+=b}return d}},a}(),TimelineGraphView=function(){"use strict";function a(a,b){this.scrollbar_={position_:0,range_:0},this.graphDiv_=$('[id="'+a+'"]')[0],this.canvas_=$('[id="'+b+'"]')[0],this.startTime_=0,this.endTime_=1,this.graph_=null,this.updateScrollbarRange_(!0)}var b=2e3,c=6,d=4,e=3,f=25,g=10,h="#CCC",i="#000",j="#FFF";a.prototype={getLength_:function(){var a=this.endTime_-this.startTime_;return Math.floor(a/b)},graphScrolledToRightEdge_:function(){return this.scrollbar_.position_==this.scrollbar_.range_},updateScrollbarRange_:function(a){var b=this.getLength_()-this.canvas_.width;0>b&&(b=0),this.scrollbar_.position_>b&&(a=!0),this.scrollbar_.range_=b,a&&(this.scrollbar_.position_=b,this.repaint())},setDateRange:function(a,b){this.startTime_=a.getTime(),this.endTime_=b.getTime(),this.endTime_<=this.startTime_&&(this.startTime_=this.endTime_-1),this.updateScrollbarRange_(!0)},updateEndDate:function(){this.endTime_=(new Date).getTime(),this.updateScrollbarRange_(this.graphScrolledToRightEdge_())},getStartDate:function(){return new Date(this.startTime_)},setDataSeries:function(a){this.graph_=new k;for(var b=0;b<a.length;++b)this.graph_.addDataSeries(a[b]);this.repaint()},addDataSeries:function(a){this.graph_||(this.graph_=new k),this.graph_.addDataSeries(a),this.repaint()},repaint:function(){this.repaintTimerRunning_=!1;var a=this.canvas_.width,c=this.canvas_.height,e=this.canvas_.getContext("2d");e.fillStyle=j,e.fillRect(0,0,a,c);var f=e.font.match(/([0-9]+)px/)[1],g=parseInt(f);if(!(0==f.length||0>=g||4*g>c||50>a)){e.save(),e.translate(.5,.5);var i=this.scrollbar_.position_;0==this.scrollbar_.range_&&(i=this.getLength_()-this.canvas_.width);var k=this.startTime_+i*b,l=c;c-=g+d,this.drawTimeLabels(e,a,c,l,k),e.strokeStyle=h,e.strokeRect(0,0,a-1,c-1),this.graph_&&(this.graph_.layout(a,c,g,k,b),this.graph_.drawTicks(e),this.graph_.drawLines(e),this.graph_.drawLabels(e)),e.restore()}},drawTimeLabels:function(a,c,d,e,g){for(var j=new Date(g).toLocaleTimeString(),k=a.measureText(j).width+f,l=[1e3,5e3,3e4,6e4,3e5,18e5,36e5,18e6],m=null,n=0;n<l.length;++n)if(l[n]/b>=k){m=l[n];break}if(m){var o=Math.ceil(g/m)*m;for(a.textBaseline="bottom",a.textAlign="center",a.fillStyle=i,a.strokeStyle=h;;){var p=Math.round((o-g)/b);if(p>=c)break;var q=new Date(o).toLocaleTimeString();a.fillText(q,p,e),a.beginPath(),a.lineTo(p,0),a.lineTo(p,d),a.stroke(),o+=m}}},getDataSeriesCount:function(){return this.graph_?this.graph_.dataSeries_.length:0},hasDataSeries:function(a){return this.graph_?this.graph_.hasDataSeries(a):!1}};var k=function(){function a(){this.dataSeries_=[],this.width_=0,this.height_=0,this.fontHeight_=0,this.startTime_=0,this.scale_=0,this.max_=0,this.labels_=[]}return a.prototype={addDataSeries:function(a){this.dataSeries_.push(a)},hasDataSeries:function(a){for(var b=0;b<this.dataSeries_.length;++b)if(this.dataSeries_[b]==a)return!0;return!1},getValues:function(a){return a.isVisible()?a.getValues(this.startTime_,this.scale_,this.width_):null},layout:function(a,b,c,d,e){this.width_=a,this.height_=b,this.fontHeight_=c,this.startTime_=d,this.scale_=e;for(var f=0,g=0;g<this.dataSeries_.length;++g){var h=this.getValues(this.dataSeries_[g]);if(h)for(var i=0;i<h.length;++i)h[i]>f&&(f=h[i])}this.layoutLabels_(f)},layoutLabels_:function(a){if(1024>a)return void this.layoutLabelsBasic_(a,0);var b=["","m","M","G","T","P"],c=1;for(a/=1024;b[c+1]&&a>=1024;)a/=1024,++c;this.layoutLabelsBasic_(a,1);for(var d=0;d<this.labels_.length;++d)this.labels_[d]+=" "+b[c];this.max_*=Math.pow(1024,c)},layoutLabelsBasic_:function(a,b){if(this.labels_=[],0==a)return void(this.max_=a);var e=2*this.fontHeight_+d,f=1+this.height_/e;2>f?f=2:f>c&&(f=c);for(var g=Math.pow(10,-b),h=b;;){if(Math.ceil(a/g)+1<=f)break;if(Math.ceil(a/(2*g))+1<=f){g*=2;break}if(Math.ceil(a/(5*g))+1<=f){g*=5;break}g*=10,h>0&&--h}this.max_=Math.ceil(a/g)*g;for(var i=this.max_;i>=0;i-=g)this.labels_.push(i.toFixed(h))},drawTicks:function(a){var b,c;b=this.width_-1,c=this.width_-1-g,a.fillStyle=h,a.beginPath();for(var d=1;d<this.labels_.length-1;++d){var e=Math.round(this.height_*d/(this.labels_.length-1));a.moveTo(b,e),a.lineTo(c,e)}a.stroke()},drawLines:function(a){var b=0,c=this.height_-1;this.max_&&(b=c/this.max_);for(var d=this.dataSeries_.length-1;d>=0;--d){var e=this.getValues(this.dataSeries_[d]);if(e){a.strokeStyle=this.dataSeries_[d].getColor(),a.beginPath();for(var f=0;f<e.length;++f)a.lineTo(f,c-Math.round(e[f]*b));a.stroke()}}},drawLabels:function(a){if(0!=this.labels_.length){var b=this.width_-e;a.fillStyle=i,a.textAlign="right",a.textBaseline="top",a.fillText(this.labels_[0],b,0),a.textBaseline="bottom";for(var c=(this.height_-1)/(this.labels_.length-1),d=1;d<this.labels_.length;++d)a.fillText(this.labels_[d],b,c*d)}}},a}();return a}(),STATS_GRAPH_CONTAINER_HEADING_CLASS="stats-graph-container-heading",bweCompoundGraphConfig={googAvailableSendBandwidth:{color:"red"},googTargetEncBitrateCorrected:{color:"purple"},googActualEncBitrate:{color:"orange"},googRetransmitBitrate:{color:"blue"},googTransmitBitrate:{color:"green"}},totalToPerSecond=function(a){var b=a.dataPoints_.length;if(b>=2){var c=a.dataPoints_[b-1],d=a.dataPoints_[b-2];return Math.round(1e3*(c.value-d.value)/(c.time-d.time))}return 0},totalBytesToBitsPerSecond=function(a){return 8*totalToPerSecond(a)},totalKiloBytesToBitsPerSecond=function(a){return totalBytesToBitsPerSecond(a)/1e3},packetsLostPercentage=function(a,b,c,d){var e=getLastValue(b,c,d,"packetsLost"),f=getLastValue(b,c,d,"packetsReceived");return null!=e&&null!=f?Math.round(100*e/(f+e)*100)/100:null},dataConversionConfig={packetsSent:{convertedName:"packetsSentPerSecond",convertFunction:totalToPerSecond},bytesSent:{convertedName:"kiloBitsSentPerSecond",convertFunction:totalKiloBytesToBitsPerSecond},packetsReceived:{convertedName:"packetsReceivedPerSecond",convertFunction:totalToPerSecond},bytesReceived:{convertedName:"kiloBitsReceivedPerSecond",convertFunction:totalKiloBytesToBitsPerSecond},packetsLost:{convertedName:"packetsLostPer",convertFunction:packetsLostPercentage},googTargetEncBitrate:{convertedName:"googTargetEncBitrateCorrected",convertFunction:function(a){var b=a.dataPoints_.length,c=a.dataPoints_[b-1];return c.value<5e3?1e3*c.value:c.value}}},graphViews={},dataSeries={},StatsTable=function(){"use strict";function a(a){this.ssrcInfoManager_=a}return a.prototype={addStatsReport:function(a,b,c,d){var e=this.ensureStatsTable_(a,d);d.stats&&this.addStatsToTable_(a,b,c,e,d.stats.timestamp,d.stats.values)},ensureStatsTableContainer_:function(a){var b=a.id+"-table-container",c=$('[id="'+b+'"]')[0];return c||(c=document.createElement("div"),c.id=b,c.className="stats-table-container",a.appendChild(c)),c},ensureStatsTable_:function(a,b){var c=a.id+"-table-"+b.type+"-"+b.id,d=$(document.getElementById(c))[0];if(!d){var e=this.ensureStatsTableContainer_(a);d=document.createElement("table"),e.appendChild(d),d.id=c,d.border=1,d.innerHTML="<tr><th colspan=2></th></tr>",d.rows[0].cells[0].textContent="Statistics "+b.type+"-"+b.id,"ssrc"==b.type&&(d.insertRow(1),d.rows[1].innerHTML="<td colspan=2></td>",this.ssrcInfoManager_.populateSsrcInfo(d.rows[1].cells[0],b.id))}return d},addStatsToTable_:function(a,b,c,d,e,f){Date(e);$(".stats-var").each(function(){var d=$(this).data("var"),e=$(this).data("type");if(matchesType(d,e,f)){var g=getLastValue(a,b,c,d);null!=g&&($(this).html(g),$(this).attr("data-avg",getAvgValue(a,b,c,d)))}})},updateStatsTableRow_:function(a,b,c){var d=a.id+"-"+b,e=$('[id="'+d+'"]')[0];e||(e=document.createElement("tr"),e.id=d,a.firstChild.appendChild(e),e.innerHTML="<td>"+b+"</td><td></td>"),e.cells[1].textContent=c}},a}(),PeerConnectionUpdateEntry=function(a,b,c,d){this.pid=a,this.lid=b,this.type=c,this.value=d},PeerConnectionUpdateTable=function(){"use strict";function a(){this.UPDATE_LOG_ID_SUFFIX_="-update-log",this.UPDATE_LOG_CONTAINER_CLASS_="update-log-container",this.UPDATE_LOG_TABLE_CLASS_="update-log-table"}return a.prototype={addPeerConnectionUpdate:function(a,b){var c=this.ensureUpdateContainer_(a),d=document.createElement("tr");if(c.firstChild.appendChild(d),d.innerHTML="<td>"+(new Date).toLocaleString()+"</td>",0==b.value.length)return void(d.innerHTML+="<td>"+b.type+"</td>");d.innerHTML+="<td><details><summary>"+b.type+"</summary></details></td>";var e=document.createElement("pre"),f=d.cells[1].childNodes[0];f.appendChild(e),e.textContent=b.value},ensureUpdateContainer_:function(a){var b=a.id+this.UPDATE_LOG_ID_SUFFIX_,c=$('[id="'+b+'"]')[0];if(!c){var d=document.createElement("div");d.className=this.UPDATE_LOG_CONTAINER_CLASS_,a.appendChild(d),c=document.createElement("table"),c.className=this.UPDATE_LOG_TABLE_CLASS_,c.id=b,c.border=1,d.appendChild(c),c.innerHTML='<tr><th>Time</th><th class="update-log-header-event">Event</th></tr>'}return c}},a}(),DumpCreator=function(){function a(a){this.recording_=!1,this.StatusStrings_={NOT_STARTED:"not started.",RECORDING:"recording..."},this.status_=this.StatusStrings_.NOT_STARTED,this.root_=document.createElement("details"),this.root_.className="peer-connection-dump-root",a.appendChild(this.root_);var b=document.createElement("summary");this.root_.appendChild(b),b.textContent="Create Dump";var c=document.createElement("pre");this.root_.appendChild(c),c.innerHTML="<button></button> Status: <span></span>",c.getElementsByTagName("button")[0].addEventListener("click",this.onToggled_.bind(this)),this.updateDisplay_()}return a.prototype={onToggled_:function(){this.recording_?(this.recording_=!1,this.status_=this.StatusStrings_.NOT_STARTED,chrome.send("stopRtpRecording")):(this.recording_=!0,this.status_=this.StatusStrings_.RECORDING,chrome.send("startRtpRecording")),this.updateDisplay_()},updateDisplay_:function(){this.root_.getElementsByTagName("button")[0].textContent=this.recording_?"Stop Recording RTP Packets":"Start Recording RTP Packets",this.root_.getElementsByTagName("span")[0].textContent=this.status_},onUpdate:function(a){this.recording_&&(this.status_=JSON.stringify(a),this.updateDisplay_())}},a}();document.addEventListener("DOMContentLoaded",initialize);var saveAs=saveAs||"undefined"!=typeof navigator&&navigator.msSaveOrOpenBlob&&navigator.msSaveOrOpenBlob.bind(navigator)||function(a){"use strict";if("undefined"==typeof navigator||!/MSIE [1-9]\./.test(navigator.userAgent)){var b=a.document,c=function(){return a.URL||a.webkitURL||a},d=a.URL||a.webkitURL||a,e=b.createElementNS("http://www.w3.org/1999/xhtml","a"),f=!a.externalHost&&"download"in e,g=a.webkitRequestFileSystem,h=a.requestFileSystem||g||a.mozRequestFileSystem,i=function(b){(a.setImmediate||a.setTimeout)(function(){throw b},0)},j="application/octet-stream",k=0,l=[],m=function(){for(var a=l.length;a--;){var b=l[a];"string"==typeof b?d.revokeObjectURL(b):b.remove()}l.length=0},n=function(a,b,c){b=[].concat(b);for(var d=b.length;d--;){var e=a["on"+b[d]];if("function"==typeof e)try{e.call(a,c||a)}catch(f){i(f)}}},o=function(d,i){var m,o,p,q=this,r=d.type,s=!1,t=function(){var a=c().createObjectURL(d);return l.push(a),a},u=function(){n(q,"writestart progress write writeend".split(" "))},v=function(){(s||!m)&&(m=t(d)),o?o.location.href=m:window.open(m,"_blank"),q.readyState=q.DONE,u()},w=function(a){return function(){return q.readyState!==q.DONE?a.apply(this,arguments):void 0}},x={create:!0,exclusive:!1};if(q.readyState=q.INIT,i||(i="download"),f){m=t(d),b=a.document,e=b.createElementNS("http://www.w3.org/1999/xhtml","a"),e.href=m,e.download=i;var y=b.createEvent("MouseEvents");return y.initMouseEvent("click",!0,!1,a,0,0,0,0,0,!1,!1,!1,!1,0,null),e.dispatchEvent(y),q.readyState=q.DONE,void u()}return a.chrome&&r&&r!==j&&(p=d.slice||d.webkitSlice,d=p.call(d,0,d.size,j),s=!0),g&&"download"!==i&&(i+=".download"),(r===j||g)&&(o=a),h?(k+=d.size,void h(a.TEMPORARY,k,w(function(a){a.root.getDirectory("saved",x,w(function(a){var b=function(){a.getFile(i,x,w(function(a){a.createWriter(w(function(b){b.onwriteend=function(b){o.location.href=a.toURL(),l.push(a),q.readyState=q.DONE,n(q,"writeend",b)},b.onerror=function(){var a=b.error;a.code!==a.ABORT_ERR&&v()},"writestart progress write abort".split(" ").forEach(function(a){b["on"+a]=q["on"+a]}),b.write(d),q.abort=function(){b.abort(),q.readyState=q.DONE},q.readyState=q.WRITING}),v)}),v)};a.getFile(i,{create:!1},w(function(a){a.remove(),b()}),w(function(a){a.code===a.NOT_FOUND_ERR?b():v()}))}),v)}),v)):void v()},p=o.prototype,q=function(a,b){return new o(a,b)};return p.abort=function(){var a=this;a.readyState=a.DONE,n(a,"abort")},p.readyState=p.INIT=0,p.WRITING=1,p.DONE=2,p.error=p.onwritestart=p.onprogress=p.onwrite=p.onabort=p.onerror=p.onwriteend=null,a.addEventListener("unload",m,!1),q.unload=function(){m(),a.removeEventListener("unload",m,!1)},q}}("undefined"!=typeof self&&self||"undefined"!=typeof window&&window||this.content);"undefined"!=typeof module&&(module.exports=saveAs);